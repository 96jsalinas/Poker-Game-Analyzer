# System Architecture: PokerHero-Analyzer

This document outlines the high-level architecture, technology stack, and data flow for the PokerHero-Analyzer application. The system is designed to parse PokerStars hand histories, store them efficiently, perform complex mathematical evaluations, and serve the insights to a web-based user interface.

## ğŸ—ï¸ Technology Stack

| Component | Technology | Rationale |
| :--- | :--- | :--- |
| **Database** | SQLite | Serverless, zero-configuration, and stores the entire database in a local file. Perfect for a fast, local analytical tool. |
| **DB Access** | Raw SQL (`sqlite3`) | Eliminates ORM overhead. Allows for highly optimized, complex analytical queries tailored specifically to our schema. |
| **Data Manipulation** | Pandas & NumPy | Industry standards for aggregating session data, calculating win rates, and manipulating time-series data for the frontend. |
| **Poker Engine** | PokerKit | Handles state management, hand evaluation, and equity calculations. Provides robust foundations for complex poker math. |
| **Frontend UI** | Dash (Plotly) | Pure-Python web framework purpose-built for interactive data dashboards. Tight integration with Pandas and Plotly charts, and sufficient UI flexibility for the drill-down hand replayer (Session â†’ Hand â†’ Action). |

> **Design Philosophy:** Storage is cheap; compute at query time is not. Derived values are pre-calculated at parse time wherever possible. See `DataStructure.MD` for the full "Numbers First, Space is Cheap" rationale.

## ğŸ”„ Data Flow Pipeline

The application follows a strictly linear data processing pipeline, moving from raw text to interactive web insights.

1. **Ingestion:** The user selects a directory containing PokerStars `.txt` hand history files.
   > âš ï¸ **Known format quirk:** PokerStars `.txt` exports are UTF-8 encoded with a BOM (`\ufeff`) prepended. The splitter discards any content before the first `PokerStars Hand #` header to handle this transparently. Always open these files with `encoding="utf-8"` (not `utf-8-sig`) â€” the splitter filters the BOM as a by-product of its header-prefix check.
2. **Parsing & Validation:** A Python parsing module reads the raw text, uses regex to extract hand actions, and validates the sequence (ensuring pots balance and actions make logical sense).
3. **Storage:** The parsed, structured data is committed to the SQLite database using raw SQL `INSERT` statements, adhering to the atomic relational schema.
  > âš ï¸ **np.int64 parameter bug:** All query functions cast `player_id`, `session_id`, and `hand_id` parameters to Python `int()` before passing to `pd.read_sql_query`. SQLite3 does not reliably accept `numpy.int64` (the type pandas returns for integer columns) as bind parameters â€” it silently returns empty results in some versions.
4. **Analysis Engine:** Upon a frontend request, the Python backend queries the SQLite database. Data is loaded into Pandas DataFrames.
5. **Mathematical Evaluation:** PokerKit and Pandas process the data to calculate complex metrics (EV, Pot Odds, SPR, MDF) for specific hands or aggregate sessions.
6. **Presentation:** The analyzed DataFrames are passed to the web frontend for rendering charts, tables, and hand replayers.

## ğŸ“‚ Current Directory Structure

All modules are implemented. The frontend uses Dash multi-page routing.

```text
pokerhero-analyzer/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ pokerhero/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ parser/               # âœ… Implemented
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ models.py         # SessionData, HandData, HandPlayerData, ActionData, ParsedHand
â”‚       â”‚   â””â”€â”€ hand_parser.py    # HandParser â€” regex-based PokerStars text parser
â”‚       â”œâ”€â”€ database/             # âœ… Implemented
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ schema.sql        # CREATE TABLE statements for all 6 tables (incl. settings)
â”‚       â”‚   â””â”€â”€ db.py             # get_connection, init_db, upsert_player, insert_*, save_parsed_hand,
â”‚       â”‚                         # update_session_financials, get_setting, set_setting, clear_all_data
â”‚       â”œâ”€â”€ ingestion/            # âœ… Implemented
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ splitter.py       # split_hands â€” splits raw session text into hand blocks
â”‚       â”‚   â””â”€â”€ pipeline.py       # IngestResult, ingest_file â€” with re-buy detection
â”‚       â”œâ”€â”€ analysis/             # âœ… Implemented
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ queries.py        # get_sessions, get_hands, get_actions, get_hero_hand_players,
â”‚       â”‚   â”‚                     # get_hero_timeline, get_hero_actions, get_export_data â†’ DataFrames
â”‚       â”‚   â””â”€â”€ stats.py          # vpip_pct, pfr_pct, win_rate_bb100, aggression_factor, wtsd_pct,
â”‚       â”‚                         # total_profit, three_bet_pct, cbet_pct, compute_equity, compute_ev
â”‚       â”œâ”€â”€ frontend/             # âœ… Implemented (multi-page Dash app)
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ app.py            # create_app() â€” use_pages=True shell, exposes DB_PATH via Flask config
â”‚       â”‚   â”œâ”€â”€ upload_handler.py # handle_upload() â€” decode base64, call ingest_file
â”‚       â”‚   â””â”€â”€ pages/
â”‚       â”‚       â”œâ”€â”€ __init__.py
â”‚       â”‚       â”œâ”€â”€ home.py       # "/" â€” navigation hub with links to Upload, Sessions, Dashboard, Settings
â”‚       â”‚       â”œâ”€â”€ upload.py     # "/upload" â€” drag-and-drop ingestion; hero username persisted to settings
â”‚       â”‚       â”œâ”€â”€ sessions.py   # "/sessions" â€” session list â†’ hand list drill-down
â”‚       â”‚       â”œâ”€â”€ dashboard.py  # "/dashboard" â€” KPI cards, bankroll graph, positional stats table
â”‚       â”‚       â””â”€â”€ settings.py   # "/settings" â€” hero username, Clear DB, Export CSV
â”‚       â””â”€â”€ config.py             # DB_PATH (overridable via POKERHERO_DB_PATH env var), setup_logging()
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ fixtures/                 # 15 .txt hand history snippets (see TestingStrategy.MD)
â”‚   â”œâ”€â”€ test_parser.py            # 150 tests across 14 classes
â”‚   â”œâ”€â”€ test_database.py          # 52 tests across 8 classes (incl. TestSettings)
â”‚   â”œâ”€â”€ test_ingestion.py         # 28 tests for pipeline, financials, re-buy detection, logging
â”‚   â”œâ”€â”€ test_frontend.py          # 54 tests for upload handler, multi-page app, page layouts, cards, action view math, dashboard, settings
â”‚   â””â”€â”€ test_analysis.py          # 66 tests for queries and stats (vpip, pfr, win_rate, AF, wtsd, timeline, 3-bet, c-bet, EV, equity cache, date filter)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ histories/                # Raw .txt session files (git-ignored)
â””â”€â”€ pyproject.toml
```

## âš ï¸ Known Limitations

### PokerStars format only
The parser (`hand_parser.py`) is tightly coupled to the PokerStars `.txt` hand history export format. No other poker platform's export format (e.g. GGPoker, 888poker, partypoker) is supported. Feeding a non-PokerStars file into the ingestion pipeline will result in parse errors or silently empty output. If multi-platform support is added in the future, the parser module will need to be refactored into a platform-specific adapter pattern.